<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DailyFlow ‚Äî –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –∏ –ø–æ–º–æ—â–Ω–∏–∫</title>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1220; --card:#0f1724; --muted:#9fb0c8; --accent:#7c5cff;
  --glass: rgba(255,255,255,0.04); --good:#10b981; --danger:#ff6b6b;
  --text:#e6eef6; --shadow: 0 6px 30px rgba(2,6,23,0.6);
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--text);background:
  radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.12), transparent 8%),
  linear-gradient(180deg,#041022 0%, #071829 60%, #081826 100%);}
.app{max-width:1200px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;gap:16px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#ff7ab6);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:white;box-shadow:0 8px 30px rgba(124,92,255,0.18)}
.h1{font-size:20px;margin:0}
.h1 small{display:block;font-weight:400;color:var(--muted);font-size:12px}
.tools{margin-left:auto;display:flex;gap:10px;align-items:center}
.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600;backdrop-filter: blur(4px)}
.btn.primary{background:linear-gradient(90deg,var(--accent),#ff7ab6);border:none;color:#fff}
.search{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
.layout{display:grid;grid-template-columns:360px 1fr 360px;gap:18px;margin-top:18px}
.left, .right{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
.center{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03);min-height:520px}
.section-title{font-weight:700;margin:0 0 8px 0}
.small{font-size:13px;color:var(--muted)}

.card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.todo-list{max-height:420px;overflow:auto;padding-right:6px}
.todo-item{display:flex;align-items:flex-start;gap:10px;padding:8px;border-radius:8px}
.check{width:18px;height:18px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;cursor:pointer}
.check.checked{background:linear-gradient(90deg,var(--good),#38bdf8);border:none;color:white}
.t-title{font-weight:600}
.meta{font-size:12px;color:var(--muted);margin-top:6px}
.controls{display:flex;gap:8px;flex-wrap:wrap}

.calendar{display:flex;flex-direction:column;gap:8px}
.day-row{display:flex;gap:8px;align-items:center}
.day{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
.day.active{background:linear-gradient(90deg,var(--accent),#ff7ab6);color:white}

.event-card{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));margin-bottom:8px}
.event-title{font-weight:700}
.event-time{font-size:13px;color:var(--muted)}

.assistant{display:flex;flex-direction:column;height:520px}
.assistant .messages{flex:1;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.assistant .input{display:flex;gap:8px;padding-top:10px}
.input textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--text);min-height:56px}
.small-muted{font-size:12px;color:var(--muted)}

.footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

/* responsive */
@media (max-width:1100px){
  .layout{grid-template-columns:1fr; padding-bottom:80px}
  .left,.right{order:2}
  .center{order:1}
}
</style>

</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">DF</div>
      <div>
        <h1 class="h1">DailyFlow <small>–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –≤–µ–±-–ø–æ–º–æ—â–Ω–∏–∫</small></h1>
      </div>
    </div>

    <div class="tools">
      <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á, —Å–æ–±—ã—Ç–∏–π..." />
      <button id="btnAddTask" class="btn">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
      <button id="btnAddEvent" class="btn">+ –°–æ–±—ã—Ç–∏–µ</button>
      <button id="btnSettings" class="btn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: –ö–æ–Ω—Ç–µ–∫—Å—Ç / Today / Tasks -->
    <div class="left">
      <div class="card">
        <div class="section-title">–°–µ–≥–æ–¥–Ω—è</div>
        <div id="todayDate" class="small muted small-muted"></div>
        <div id="digest" class="meta" style="margin-top:10px">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç: –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      </div>

      <div class="card">
        <div class="section-title">–ó–∞–¥–∞—á–∏</div>
        <div class="small">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á ‚Äî –æ—Ç–º–µ—á–∞–π –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ</div>
        <div class="todo-list" id="todoList" style="margin-top:10px"></div>
        <div style="margin-top:8px" class="controls">
          <button id="btnExport" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button id="btnImport" class="btn">–ò–º–ø–æ—Ä—Ç</button>
          <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å (–≤—ã–±–µ—Ä–∏ –¥–∞—Ç—É)</div>
        <div id="calendar" class="calendar"></div>
      </div>
    </div>

    <!-- CENTER: –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ / —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π / —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
    <div class="center">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0">–ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</h2>
        <div class="small-muted">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ <select id="sortSel" style="background:transparent;color:var(--text);border:none">
          <option value="time">–ø–æ –≤—Ä–µ–º–µ–Ω–∏</option>
          <option value="priority">–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
        </select></div>
      </div>

      <div id="eventsFeed" style="margin-top:12px"></div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É / —Å–æ–±—ã—Ç–∏–µ</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <input id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
          <select id="priority" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
          <input id="dueDate" type="date" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
          <input id="dueTime" type="time" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
          <button id="addTaskBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

    </div>

    <!-- RIGHT: Assistant / settings -->
    <div class="right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="section-title">–í–µ–±-–ø–æ–º–æ—â–Ω–∏–∫</div>
          <div class="small-muted">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî –æ—Ç–≤–µ—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ + –æ–ø—Ü–∏—è OpenAI</div>
        </div>
        <button id="clearChat" class="btn">üßπ</button>
      </div>

      <div class="assistant card" style="margin-top:10px">
        <div class="messages" id="messages"></div>
        <div class="input">
          <textarea id="assistantInput" placeholder="–°–ø—Ä–æ—Å–∏ –ø–æ–º–æ—â–Ω–∏–∫–∞: –≥–¥–µ –º–æ–π –¥–µ–¥–ª–∞–π–Ω? –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?"></textarea>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="sendMsg" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button id="useOpenAI" class="btn">OpenAI (–æ–ø—Ü–∏—è)</button>
          </div>
        </div>
        <div style="margin-top:8px">
          <div class="small-muted">OpenAI –∫–ª—é—á: <input id="openaiKey" placeholder="sk-..." style="padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" /></div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="margin-top:8px" class="small-muted">
          <label><input id="notificationsToggle" type="checkbox" /> –í–∫–ª—é—á–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label><br/>
          <label><input id="soundToggle" type="checkbox" /> –ó–≤—É–∫ –ø—Ä–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏</label><br/>
          <label><input id="dailyToggle" type="checkbox" /> –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç (—É—Ç—Ä–æ–º)</label>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">DailyFlow ‚Äî –¥–µ–ª–∞–π –±–æ–ª—å—à–µ, –∑–∞–±—ã–≤–∞–π –º–µ–Ω—å—à–µ. ¬© 2025</div>
</div>

<!-- Audio -->
<audio id="ding" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="></audio>

<script>
/* ========= –ü—Ä–æ—Å—Ç–æ–π SPA –ª–æ–≥–∏–∫–∞ ========= */

/* STORAGE key */
const STORAGE_KEY = "dailyflow_v1";

/* state */
let state = {
  tasks: [], // {id,title,date,time,priority,done}
  events: [], // {id,title,link,date,time,desc}
  messages: [], // assistant messages
  settings: { notifications: false, sound: true, dailyDigest: false, openaiKey: "" }
};

/* init */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ state = JSON.parse(raw); }
  } catch(e){ console.error("loadState", e); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function formatDate(d){
  const dt = new Date(d);
  return dt.toLocaleDateString();
}

/* Rendering */
const todayDate = document.getElementById("todayDate");
const todoList = document.getElementById("todoList");
const eventsFeed = document.getElementById("eventsFeed");
const calendar = document.getElementById("calendar");
const digest = document.getElementById("digest");
const messagesEl = document.getElementById("messages");
const openaiKeyInput = document.getElementById("openaiKey");

function render(){
  // header date
  const now = new Date();
  todayDate.textContent = now.toLocaleString();

  // todo list
  todoList.innerHTML = "";
  state.tasks.sort((a,b)=> (a.done - b.done) || (a.priority === b.priority ? 0 : (a.priority==="high"? -1:1)));
  state.tasks.forEach(t=>{
    const div = document.createElement("div");
    div.className = "todo-item";
    div.innerHTML = `
      <div class="check ${t.done ? "checked":""}" data-id="${t.id}">${t.done ? "‚úì":""}</div>
      <div style="flex:1">
        <div class="t-title">${escapeHtml(t.title)}</div>
        <div class="meta">${t.date ? t.date : "–±–µ–∑ –¥–∞—Ç—ã"} ${t.time ? "‚Ä¢ "+t.time : ""} ‚Ä¢ ${t.priority}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" data-edit="${t.id}">‚úè</button>
        <button class="btn" data-del="${t.id}">üóë</button>
      </div>
    `;
    todoList.appendChild(div);
  });

  // events feed (today)
  eventsFeed.innerHTML = "";
  const dayKey = (new Date()).toISOString().slice(0,10);
  const todays = state.events.filter(e=> e.date === dayKey).sort((a,b)=> (a.time||"") < (b.time||"") ? -1:1);
  if(todays.length===0){
    eventsFeed.innerHTML = `<div class="small-muted">–°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>`;
  }else{
    todays.forEach(ev=>{
      const el = document.createElement("div");
      el.className = "event-card";
      el.innerHTML = `<div class="event-title">${escapeHtml(ev.title)}</div>
        <div class="event-time">${ev.time || "–≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ"}</div>
        <div class="small" style="margin-top:8px">${escapeHtml(ev.desc || "")}</div>
      `;
      eventsFeed.appendChild(el);
    });
  }

  // calendar: simple next 14 days
  calendar.innerHTML = "";
  const start = new Date();
  for(let i=0;i<14;i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i);
    const key = d.toISOString().slice(0,10);
    const count = state.events.filter(ev=>ev.date===key).length + state.tasks.filter(t=>t.date===key && !t.done).length;
    const day = document.createElement("div");
    day.className = "day-row";
    day.innerHTML = `<div class="day ${i===0?'active':''}" data-date="${key}">${d.getDate()}</div>
      <div style="font-size:13px;color:var(--muted)">${d.toLocaleDateString(undefined,{weekday:'short'})} ${count?(" ‚Ä¢ "+count):""}</div>`;
    calendar.appendChild(day);
  }

  // digest summary (simple)
  const upcoming = state.events.slice(0,3).map(e=>e.title).join(" ‚Ä¢ ");
  digest.textContent = upcoming ? upcoming : "–ü—É—Å—Ç–æ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è";

  // assistant messages
  messagesEl.innerHTML = "";
  state.messages.forEach(m=>{
    const mdiv = document.createElement("div");
    mdiv.style.marginBottom = "8px";
    mdiv.innerHTML = `<div style="font-size:12px;color:var(--muted)">${m.role}</div><div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:4px">${escapeHtml(m.text)}</div>`;
    messagesEl.appendChild(mdiv);
  });

  openaiKeyInput.value = state.settings.openaiKey || "";
}

/* helpers */
function escapeHtml(s){ if(!s) return ""; return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

/* Actions: add/edit/delete tasks/events */
document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  const title = document.getElementById("taskTitle").value.trim();
  if(!title){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"); return; }
  const date = document.getElementById("dueDate").value || null;
  const time = document.getElementById("dueTime").value || null;
  const priority = document.getElementById("priority").value || "medium";
  const newTask = { id: uid(), title, date, time, priority, done:false };
  state.tasks.push(newTask);
  saveState(); render(); scheduleNotificationForTask(newTask);
  document.getElementById("taskTitle").value = "";
});

document.getElementById("btnAddTask").addEventListener("click", ()=> document.getElementById("taskTitle").focus());
document.getElementById("btnAddEvent").addEventListener("click", ()=> {
  const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:");
  if(!title) return;
  const date = prompt("–î–∞—Ç–∞ (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
  const time = prompt("–í—Ä–µ–º—è (HH:MM):", "");
  const desc = prompt("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:", "");
  state.events.push({ id: uid(), title, date, time, desc });
  saveState(); render();
});

/* delegated events for todo items */
todoList.addEventListener("click", (ev)=>{
  const ch = ev.target.closest(".check");
  if(ch){
    const id = ch.dataset.id;
    const t = state.tasks.find(x=>x.id===id);
    if(t){ t.done = !t.done; saveState(); render(); }
  }
  const del = ev.target.closest("[data-del]");
  if(del){
    const id = del.dataset.del;
    state.tasks = state.tasks.filter(x=>x.id!==id);
    saveState(); render();
  }
  const edit = ev.target.closest("[data-edit]");
  if(edit){
    const id = edit.dataset.edit;
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    const newTitle = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫:", t.title);
    if(newTitle !== null){ t.title = newTitle; saveState(); render(); }
  }
});

/* import/export/clear */
document.getElementById("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "dailyflow-export.json"; a.click();
});
document.getElementById("btnImport").addEventListener("click", ()=>{
  const input = document.createElement("input"); input.type="file"; input.accept=".json";
  input.onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try { const j = JSON.parse(r.result); state = j; saveState(); render(); alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"); } catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); }
    }
    r.readAsText(f);
  }
  input.click();
});
document.getElementById("btnClear").addEventListener("click", ()=>{
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–ª–æ–∫–∞–ª—å–Ω–æ)?")){ state = {tasks:[],events:[],messages:[],settings:state.settings}; saveState(); render(); }
});

/* search */
document.getElementById("search").addEventListener("input", (e)=>{
  const q = e.target.value.toLowerCase();
  document.querySelectorAll(".t-title").forEach(el=> {
    el.closest(".todo-item").style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});

/* calendar click */
calendar.addEventListener("click", (e)=>{
  const d = e.target.closest(".day");
  if(!d) return;
  document.querySelectorAll(".day").forEach(x=>x.classList.remove("active"));
  d.classList.add("active");
  const date = d.dataset.date;
  // show events for date
  const list = state.events.filter(ev=>ev.date===date);
  if(list.length===0){ alert("–°–æ–±—ã—Ç–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç"); return; }
  const txt = list.map(x=>`${x.time||''} ${x.title} ‚Äî ${x.desc||''}`).join("\n\n");
  alert("–°–æ–±—ã—Ç–∏—è:\n\n"+txt);
});

/* Assistant */
document.getElementById("sendMsg").addEventListener("click", async ()=>{
  const txt = document.getElementById("assistantInput").value.trim();
  if(!txt) return;
  addMessage("user", txt);
  document.getElementById("assistantInput").value = "";
  // simple local rules:
  const lower = txt.toLowerCase();
  if(lower.includes("—Å–∫–æ–ª—å–∫–æ") && lower.includes("–∑–∞–¥–∞—á")){
    const pending = state.tasks.filter(t=>!t.done).length;
    addMessage("assistant", `–£ —Ç–µ–±—è ${pending} –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.`);
    return;
  }
  if(lower.includes("–Ω–∞–ø–æ–º–Ω–∏") || lower.includes("–ø–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ")){
    addMessage("assistant", "–ß—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –¥–æ–±–∞–≤—å –∑–∞–¥–∞—á—É –∏ —É–∫–∞–∂–∏ –¥–∞—Ç—É/–≤—Ä–µ–º—è. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.");
    return;
  }

  // if openai key present and user wants it
  const useOpenAI = document.getElementById("useOpenAI").clickedTimes || false;
  const key = state.settings.openaiKey || openaiKeyInput.value.trim();
  if(key && (lower.includes("–æ–±—ä—è—Å–Ω–∏") || lower.includes("–ø–µ—Ä–µ–≤–µ–¥–∏") || document.getElementById("useOpenAI").dataset.forced==="1")){
    // call OpenAI
    addMessage("assistant", "–ó–∞–ø—Ä–æ—Å –∫ OpenAI –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...");
    try {
      const resp = await callOpenAI(key, txt);
      addMessage("assistant", resp || "[OpenAI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç]");
    } catch(e){
      addMessage("assistant", "[–û—à–∏–±–∫–∞ OpenAI] "+e.message);
    }
  } else {
    // fallback: echo + suggestion
    addMessage("assistant", "–Ø –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –º–æ–≥—É –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∑–∞–¥–∞—á–∏, –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∫–∞–∫ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –±–æ—Ç. –ü–æ–ø—Ä–æ–±—É–π: ¬´–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á —É –º–µ–Ω—è¬ª –∏–ª–∏ ¬´–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ 10:00 –ø–æ–∑–≤–æ–Ω–∏—Ç—å¬ª.");
  }
});

document.getElementById("useOpenAI").addEventListener("click", ()=>{
  // mark that user wants to use OpenAI on next query
  document.getElementById("useOpenAI").dataset.forced = "1";
  document.getElementById("assistantInput").focus();
});
openaiKeyInput.addEventListener("change", ()=>{
  state.settings.openaiKey = openaiKeyInput.value.trim();
  saveState();
});

/* assistant message helpers */
function addMessage(role, text){
  state.messages.push({ id: uid(), role, text, ts: Date.now() });
  saveState(); render();
  // scroll messages
  setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 50);
}

/* OpenAI call (optional) */
async function callOpenAI(key, prompt){
  // note: this uses the Responses endpoint; may need adjustment
  const res = await fetch("https://api.openai.com/v1/responses", {
    method:"POST",
    headers:{"Authorization":"Bearer "+key,"Content-Type":"application/json"},
    body: JSON.stringify({ model:"gpt-4o-mini", input: prompt })
  });
  if(!res.ok){ throw new Error("OpenAI: "+res.status+" "+await res.text()); }
  const j = await res.json();
  // try to extract text
  if(j.output_text) return j.output_text;
  let out = "";
  if(j.output && Array.isArray(j.output)){
    j.output.forEach(o=>{ if(o.content) o.content.forEach(c=>{ if(c.text) out += c.text })});
  }
  return out || JSON.stringify(j);
}

/* Notifications and schedule */
const ding = document.getElementById("ding");
function requestNotifications(){
  if(!("Notification" in window)) return alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
  Notification.requestPermission().then(p=>{
    if(p==="granted"){ state.settings.notifications = true; saveState(); alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã"); }
  });
}

document.getElementById("notificationsToggle").addEventListener("change",(e)=>{
  const on = e.target.checked;
  state.settings.notifications = on;
  saveState();
  if(on) requestNotifications();
});
document.getElementById("soundToggle").addEventListener("change",(e)=>{ state.settings.sound = e.target.checked; saveState() });
document.getElementById("dailyToggle").addEventListener("change",(e)=>{ state.settings.dailyDigest = e.target.checked; saveState() });

/* scheduling: check every minute for due items */
let schedulerInterval = null;
function scheduleCheckerStart(){
  if(schedulerInterval) clearInterval(schedulerInterval);
  schedulerInterval = setInterval(()=> {
    checkDueItems();
  }, 30*1000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
}
function checkDueItems(){
  const now = new Date();
  state.tasks.forEach(t=>{
    if(t.done) return;
    if(!t.date || !t.time) return;
    if(t._notified) return;
    const dt = new Date(t.date + "T" + (t.time || "00:00"));
    if(Math.abs(dt - now) < 60*1000){ // within 1 minute
      // notify
      if(state.settings.notifications && Notification.permission === "granted"){
        new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "+t.title, { body: (t.time?("–≤ "+t.time):"") });
      }
      if(state.settings.sound) ding.play();
      t._notified = true;
      saveState();
      addMessage("assistant", `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: "${t.title}" ‚Äî –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ.`);
    }
  });
  // also events
  state.events.forEach(ev=>{
    if(ev._notified) return;
    if(!ev.date || !ev.time) return;
    const dt = new Date(ev.date + "T" + ev.time);
    if(Math.abs(dt - new Date()) < 60*1000){
      if(state.settings.notifications && Notification.permission === "granted"){
        new Notification("–°–æ–±—ã—Ç–∏–µ: "+ev.title, { body: ev.desc || "" });
      }
      if(state.settings.sound) ding.play();
      ev._notified = true; saveState();
    }
  });
}

/* schedule notification for a new task */
function scheduleNotificationForTask(task){
  // if the date/time is soon, it will be picked up by checker
}

/* load/save on start */
loadState(); render(); scheduleCheckerStart();

/* initial examples */
if(state.tasks.length===0 && state.events.length===0){
  state.tasks.push({id:uid(), title:"–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ—á—Ç—É", date:(new Date()).toISOString().slice(0,10), time:"09:30", priority:"medium", done:false});
  state.tasks.push({id:uid(), title:"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç –¥–ª—è –∫–æ–º–∞–Ω–¥—ã", date:(new Date()).toISOString().slice(0,10), time:"15:00", priority:"high", done:false});
  state.events.push({id:uid(), title:"–í—Å—Ç—Ä–µ—á–∞ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º", date:(new Date()).toISOString().slice(0,10), time:"11:00", desc:"Zoom, –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é"});
  saveState(); render();
}

/* Settings button */
document.getElementById("btnSettings").addEventListener("click", ()=> {
  alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n- –†–∞–∑—Ä–µ—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)\n- –í—Å—Ç–∞–≤—å OpenAI –∫–ª—é—á —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å GPT-–æ—Ç–≤–µ—Ç—ã —Å –æ–±–ª–∞–∫–∞\n\n–ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
});

/* help / quicktips */
addMessage("assistant", "–ü—Ä–∏–≤–µ—Ç! –Ø –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æc–∏ –º–µ–Ω—è –æ –∑–∞–¥–∞—á–∞—Ö –∏–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö. –ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenAI, –≤—Å—Ç–∞–≤—å –∫–ª—é—á –∏ –Ω–∞–∂–º–∏ 'OpenAI (–æ–ø—Ü–∏—è)'.");
/* end script */
</script>

</body>
</html>
