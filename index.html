<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>StarFlow ‚Äî –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1: #030317;
  --bg-2: #061234;
  --card: rgba(255,255,255,0.03);
  --glass: rgba(255,255,255,0.03);
  --muted: #9fb0c8;
  --accent: linear-gradient(90deg,#7c5cff,#ff7ab6);
  --accent-plain: #7c5cff;
  --success: #22c55e;
  --danger: #ff5c6c;
  --text: #e6eef6;
  --radius: 14px;
  --shadow: 0 10px 30px rgba(2,6,23,0.6);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:
  radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.06), transparent 8%),
  linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 80%);color:var(--text);-webkit-font-smoothing:antialiased}
.app{max-width:1100px;margin:16px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;padding:8px 4px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c5cff,#ff7ab6);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;box-shadow:0 10px 30px rgba(124,92,255,0.18)}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600}
.btn.primary{background:linear-gradient(90deg,#7c5cff,#ff7ab6);border:none;color:white;box-shadow:0 6px 18px rgba(124,92,255,0.12)}
.search{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--text);min-width:160px}

/* overall layout */
.container{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px}
.left{min-height:640px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
.right{min-height:640px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;background:transparent;border:1px solid rgba(255,255,255,0.02)}
.tab.active{background:linear-gradient(90deg,#7c5cff,#ff7ab6);color:white;box-shadow:0 8px 30px rgba(124,92,255,0.10)}
.content{padding:8px}
.section-title{font-weight:700;margin:6px 0 10px 0;font-size:16px}
.small{font-size:13px;color:var(--muted)}

/* Tasks list */
.tasks{display:flex;flex-direction:column;gap:10px}
.task-card{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02);transition:transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s;}
.task-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(2,6,23,0.6)}
.task-left{width:36px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.task-left.done{background:linear-gradient(90deg,#22c55e,#06b6d4);color:white;border:none}
.task-body{flex:1}
.task-title{font-weight:700}
.task-meta{font-size:12px;color:var(--muted)}
.task-actions{display:flex;gap:6px}

/* cowboy animation area */
.cowboy-area{position:relative;height:90px;overflow:hidden;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;padding:8px}
.cowboy{position:absolute;left:10px;bottom:6px;width:80px;transform-origin:center;transition:transform .25s}
.cowboy img{width:100%;height:auto;display:block;filter:drop-shadow(0 8px 16px rgba(0,0,0,0.6))}

/* running animation (CSS sprite-like small oscillation) */
@keyframes run-cycle {
  0%{transform:translateX(0) rotate(0) scale(1)}
  30%{transform:translateX(10px) rotate(-2deg) scale(1.02)}
  60%{transform:translateX(-6px) rotate(1deg) scale(0.99)}
  100%{transform:translateX(0) rotate(0) scale(1)}
}
.cowboy.run{animation:run-cycle .9s linear infinite}

/* pop-in for new task */
@keyframes pop-in {
  0%{opacity:0; transform:scale(.92)}
  60%{opacity:1; transform:scale(1.03)}
  100%{transform:scale(1)}
}
.task-card.new{animation:pop-in .45s cubic-bezier(.2,.9,.2,1)}

/* complete pulse */
@keyframes pulse {
  0%{box-shadow:0 0 0 rgba(34,197,94,0.0)}
  50%{box-shadow:0 0 18px rgba(34,197,94,0.18)}
  100%{box-shadow:0 0 0 rgba(34,197,94,0.0)}
}
.task-card.completed{animation:pulse .9s ease-out 1}

/* Calendar */
.calendar {display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.cal-cell{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:8px;border-radius:8px;min-height:80px;border:1px solid rgba(255,255,255,0.02);position:relative}
.cal-cell .daynum{position:absolute;top:8px;left:8px;font-weight:700}
.cal-cell .events{position:absolute;bottom:8px;left:8px;right:8px;font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:4px}
.cal-cell.today{outline:2px solid rgba(124,92,255,0.14)}

/* mobile responsive */
@media (max-width:900px){
  .container{grid-template-columns:1fr; padding-bottom:60px}
  .right{order:2}
  .left{order:1}
  .cowboy-area{height:76px}
  .cowboy{width:64px}
  .logo{width:52px;height:52px}
  .title{font-size:16px}
}

/* cosmic particles - background decoration */
.particles{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;mix-blend-mode:screen;opacity:0.35}
.particle{position:absolute;border-radius:50%;background:radial-gradient(circle,#fff8 0%, #fff0 50%);filter:blur(6px);opacity:0.6}
</style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="app" id="appRoot">
  <div class="header">
    <div class="logo">SF</div>
    <div>
      <div class="title">StarFlow <div class="small">–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å</div></div>
    </div>
    <div class="header-right">
      <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." />
      <button id="btnAdd" class="btn primary">+ –ó–∞–¥–∞—á–∞</button>
      <button id="btnMenu" class="btn">‚ò∞</button>
    </div>
  </div>

  <div class="container" id="mainContainer">
    <!-- LEFT: tabs and tasks -->
    <div class="left">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="tasks">–ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <div class="tab" data-tab="digest">–î–∞–π–¥–∂–µ—Å—Ç</div>
        <div class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      </div>

      <div class="content">
        <!-- TASKS TAB -->
        <div class="tab-pane" id="pane-tasks">
          <div class="section-title">–ú–æ–∏ –∑–∞–¥–∞—á–∏</div>
          <div class="small">–î–æ–±–∞–≤–ª—è–π –¥–µ–ª–∞, –Ω–∞–∑–Ω–∞—á–∞–π –¥–µ–¥–ª–∞–π–Ω—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</div>
          <div style="height:12px"></div>

          <div class="cowboy-area" id="cowboyArea" aria-hidden>
            <!-- cowboy image: replace assets/cowboy.png with your image file if you have one -->
            <div class="cowboy" id="cowboy">
              <img src="assets/cowboy.png" alt="cowboy" id="cowboyImg" />
            </div>
            <div style="margin-left:120px;color:var(--muted);">–ö–æ–≤–±–æ–π –≤–æ–∑–ª–µ –∑–∞–¥–∞—á ‚Äî –æ–Ω –±–µ–≥–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ç—ã –¥–æ–±–∞–≤–ª—è–µ—à—å –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—à—å –∑–∞–¥–∞—á—É ü§†</div>
          </div>

          <div style="height:12px"></div>
          <div class="tasks" id="tasksList"></div>
        </div>

        <!-- CALENDAR TAB -->
        <div class="tab-pane" id="pane-calendar" style="display:none">
          <div class="cal-head">
            <div>
              <button class="btn" id="calPrev">&larr;</button>
              <span id="calMonth" style="font-weight:700;margin:0 10px"></span>
              <button class="btn" id="calNext">&rarr;</button>
            </div>
            <div class="small">–ö–ª–∏–∫ –Ω–∞ –¥–∞—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</div>
          </div>
          <div class="calendar" id="calendarGrid"></div>
        </div>

        <!-- DIGEST TAB -->
        <div class="tab-pane" id="pane-digest" style="display:none">
          <div class="section-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç</div>
          <div class="small">–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –∑–∞–¥–∞—á –∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å</div>
          <div id="digestArea" style="margin-top:12px"></div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-pane" id="pane-settings" style="display:none">
          <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="small">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
          <div style="margin-top:12px" class="small">
            <label><input type="checkbox" id="notifToggle"> –í–∫–ª—é—á–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label><br/>
            <label><input type="checkbox" id="soundToggle" checked> –ó–≤—É–∫ –ø—Ä–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏</label><br/>
            <div style="height:8px"></div>
            <button id="btnExport" class="btn">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            <button id="btnImport" class="btn">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            <button id="btnClearAll" class="btn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: quick add & upcoming -->
    <div class="right">
      <div class="section-title">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div>
      <div class="small">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∑–∞ 2 —à–∞–≥–∞</div>

      <div style="height:12px"></div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="quickTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
        <input id="quickDate" type="date" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
        <input id="quickTime" type="time" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
        <select id="quickPriority" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
          <option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option>
        </select>
        <div style="display:flex;gap:8px">
          <button id="quickAddBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
          <button id="quickAddEvent" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>
      </div>

      <div style="height:18px"></div>
      <div class="section-title">–°–∫–æ—Ä–æ</div>
      <div id="upcomingList" class="small" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>
</div>

<!-- audio ding -->
<audio id="audioDing">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script>
/* ====== configuration & assets ====== */
// change cowboySrc to your provided image file path if you have one
const cowboySrc = "assets/cowboy.png"; // <- put your cowboy image in assets/cowboy.png or change path
// If you're hosting on GitHub Pages, upload assets/cowboy.png into repo next to index.html

/* ====== state & storage ====== */
const STORAGE = "starflow_v1";
let state = { tasks: [], events: [], settings: {notifications:false, sound:true} };

/* load/save */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE);
    if(raw) state = JSON.parse(raw);
  }catch(e){ console.error(e); }
}
function saveState(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

/* init demo if empty */
function seedData(){
  if(state.tasks.length===0 && state.events.length===0){
    const d = new Date().toISOString().slice(0,10);
    state.tasks.push({id: uid(), title:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É", date:d, time:"09:00", priority:"medium", done:false});
    state.tasks.push({id: uid(), title:"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç", date:d, time:"15:00", priority:"high", done:false});
    state.events.push({id: uid(), title:"–í—Å—Ç—Ä–µ—á–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π", date:d, time:"11:00", desc:"Zoom ‚Äî –ø–ª–∞–Ω —Å–ø—Ä–∏–Ω—Ç–∞"});
    saveState();
  }
}

/* utils */
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6) }
function el(q) { return document.querySelector(q) }
function els(q) { return Array.from(document.querySelectorAll(q)) }
function dateKey(dt){ return dt ? dt.slice(0,10) : null }

/* ====== render ====== */
const tasksList = el("#tasksList");
const upcomingList = el("#upcomingList");
const cowboyEl = el("#cowboy");
const cowboyArea = el("#cowboyArea");
const audioDing = el("#audioDing");

function renderAll(){
  renderTasks();
  renderUpcoming();
  renderCalendar(currentYear, currentMonth);
  renderDigest();
}

/* tasks */
function renderTasks(){
  tasksList.innerHTML = "";
  // sort: unfinished by priority then time
  const sorted = state.tasks.slice().sort((a,b)=>{
    if(a.done !== b.done) return a.done?1:-1;
    if(a.priority!==b.priority) return (a.priority==="high"? -1:1);
    if(a.date && b.date) return (a.date < b.date ? -1:1);
    return 0;
  });
  sorted.forEach(t=>{
    const card = document.createElement("div");
    card.className = "task-card"+ (t.new? " new": "") + (t.done? " completed": "");
    card.dataset.id = t.id;
    card.innerHTML = `
      <div class="task-left ${t.done? "done": ""}" data-action="toggle">${t.done? "‚úì": ""}</div>
      <div class="task-body">
        <div class="task-title">${escapeHtml(t.title)}</div>
        <div class="task-meta">${t.date? t.date : "–±–µ–∑ –¥–∞—Ç—ã"} ${t.time? " ‚Ä¢ "+t.time : ""} ‚Ä¢ ${t.priority}</div>
      </div>
      <div class="task-actions">
        <button class="btn" data-action="edit">‚úè</button>
        <button class="btn" data-action="del">üóë</button>
      </div>
    `;
    tasksList.appendChild(card);
    // remove new flag after animation
    if(t.new){ setTimeout(()=> { delete t.new; saveState(); renderTasks(); }, 700); }
  });
}

/* upcoming */
function renderUpcoming(){
  upcomingList.innerHTML = "";
  const soon = state.tasks.concat(state.events).slice().sort((a,b)=>{
    const ta = (a.date||"9999")+ (a.time||"00");
    const tb = (b.date||"9999")+ (b.time||"00");
    return ta < tb ? -1:1;
  }).slice(0,6);
  soon.forEach(it=>{
    const div = document.createElement("div");
    div.style.display = "flex"; div.style.justifyContent = "space-between";
    div.innerHTML = `<div>${escapeHtml(it.title || it.eventTitle)} <div style="font-size:12px;color:${it.done? 'var(--muted)':''}">${it.date||''} ${it.time||''}</div></div>
      <div style="color:var(--muted);font-size:12px">${it.priority? it.priority : "—Å–æ–±—ã—Ç–∏–µ"}</div>`;
    upcomingList.appendChild(div);
  });
}

/* task interactions (delegated) */
tasksList.addEventListener("click", (e)=>{
  const action = e.target.closest("[data-action]");
  if(!action) return;
  const act = action.dataset.action;
  const card = e.target.closest(".task-card");
  const id = card.dataset.id;
  if(act==="toggle"){
    const t = state.tasks.find(x=>x.id===id);
    if(t){ t.done = !t.done; t._justCompleted = t.done; saveState(); renderAll(); triggerCowboyRun(t._justCompleted ? "celebrate":"run"); if(t._justCompleted){ card.classList.add("completed"); setTimeout(()=>card.classList.remove("completed"),900);} }
  } else if(act==="del"){
    if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")){ state.tasks = state.tasks.filter(x=>x.id!==id); saveState(); renderAll(); }
  } else if(act==="edit"){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    const newTitle = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É:", t.title);
    if(newTitle !== null){ t.title = newTitle; saveState(); renderAll(); }
  }
});

/* quick add */
el("#quickAddBtn").addEventListener("click", ()=>{
  const title = el("#quickTitle").value.trim(); if(!title) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
  const date = el("#quickDate").value || null;
  const time = el("#quickTime").value || null;
  const priority = el("#quickPriority").value;
  const task = { id: uid(), title, date, time, priority, done:false, new:true };
  state.tasks.push(task); saveState(); renderAll(); el("#quickTitle").value=""; el("#quickDate").value=""; el("#quickTime").value="";
  triggerCowboyRun("run");
  scheduleCheck(); 
});

/* main add button */
el("#btnAdd").addEventListener("click", ()=> {
  const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");
  if(!title) return;
  const date = prompt("–î–∞—Ç–∞ (YYYY-MM-DD) ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–µ—Ç:", "");
  const time = prompt("–í—Ä–µ–º—è (HH:MM) ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–µ—Ç:", "");
  const pr = prompt("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (low/medium/high)", "medium");
  const task = { id: uid(), title, date: date||null, time: time||null, priority: pr||"medium", done:false, new:true };
  state.tasks.push(task); saveState(); renderAll(); triggerCowboyRun("run"); scheduleCheck();
});

/* quick event */
el("#quickAddEvent").addEventListener("click", ()=>{
  const title = el("#quickTitle").value.trim(); if(!title) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è");
  const date = el("#quickDate").value || null;
  const time = el("#quickTime").value || null;
  const ev = { id: uid(), title, date, time, desc:"" };
  state.events.push(ev); saveState(); renderAll();
});

/* search */
el("#search").addEventListener("input",(e)=>{
  const q = e.target.value.toLowerCase();
  els(".task-card").forEach(card=>{
    const txt = (card.querySelector(".task-title").innerText || "").toLowerCase();
    card.style.display = txt.includes(q) ? "" : "none";
  });
});

/* ===== calendar implementation (monthly view) ===== */
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

function renderCalendar(y,m){
  const grid = el("#calendarGrid"); grid.innerHTML = "";
  const monthNames = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
  el("#calMonth").innerText = monthNames[m] + " " + y;
  const first = new Date(y,m,1);
  const startDay = first.getDay(); // 0..6 (Sun..Sat)
  // compute days in month
  const daysInMonth = new Date(y,m+1,0).getDate();
  // fill leading empty cells for week start (we'll treat week starting Sun)
  // create 7 * 6 grid cells
  let cells = [];
  for(let i=0;i<42;i++){ cells.push(i - startDay + 1); } // day number may be <=0 or > daysInMonth
  cells.forEach(n=>{
    const cell = document.createElement("div");
    cell.className = "cal-cell";
    if(n > 0 && n <= daysInMonth){
      const dayStr = String(n).padStart(2,"0");
      const dateStr = `${y}-${String(m+1).padStart(2,"0")}-${dayStr}`;
      cell.innerHTML = `<div class="daynum">${n}</div><div class="events"></div>`;
      // mark today
      if(dateStr === (new Date()).toISOString().slice(0,10)) cell.classList.add("today");
      // list events count
      const evs = state.events.filter(ev=>ev.date === dateStr);
      const tks = state.tasks.filter(t=>t.date === dateStr && !t.done);
      const listEl = cell.querySelector(".events");
      evs.slice(0,3).forEach(ev=>{
        const d = document.createElement("div"); d.innerText = `üìå ${ev.title} ${ev.time? "‚Ä¢ "+ev.time : ""}`; listEl.appendChild(d);
      });
      tks.slice(0,2).forEach(t=>{
        const d = document.createElement("div"); d.innerText = `‚Ä¢ ${t.title}`; d.style.color = "var(--muted)"; d.style.fontSize="12px"; listEl.appendChild(d);
      });
      // click to add event or see
      cell.addEventListener("click", ()=> {
        const act = prompt("–í–≤–µ–¥–∏—Ç–µ 1 —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ, 2 —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è, 3 —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É (1/2/3)", "2");
        if(!act) return;
        if(act === "1"){
          const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:");
          if(!title) return;
          const time = prompt("–í—Ä–µ–º—è (HH:MM)","")
          state.events.push({id: uid(), title, date: dateStr, time, desc:""});
          saveState(); renderAll();
        } else if(act === "3"){
          const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");
          if(!title) return;
          const time = prompt("–í—Ä–µ–º—è (HH:MM)","");
          state.tasks.push({id: uid(), title, date: dateStr, time, priority:"medium", done:false, new:true});
          saveState(); renderAll(); triggerCowboyRun("run");
        } else {
          const list = state.events.filter(ev=>ev.date===dateStr);
          if(list.length===0) alert("–°–æ–±—ã—Ç–∏–π –Ω–µ—Ç");
          else alert(list.map(x=>`${x.time||""} ${x.title} ‚Äî ${x.desc||""}`).join("\n\n"));
        }
      });
    } else {
      cell.style.opacity = "0.04";
    }
    grid.appendChild(cell);
  });
}

/* calendar navigation */
el("#calPrev").addEventListener("click", ()=>{ currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; } renderCalendar(currentYear,currentMonth); });
el("#calNext").addEventListener("click", ()=>{ currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; } renderCalendar(currentYear,currentMonth); });

/* digest */
function renderDigest(){
  const todayKey = (new Date()).toISOString().slice(0,10);
  const todaysTasks = state.tasks.filter(t=>t.date===todayKey && !t.done);
  const todaysEvents = state.events.filter(e=>e.date===todayKey);
  const elD = el("#digestArea"); elD.innerHTML = "";
  if(todaysEvents.length===0 && todaysTasks.length===0){ elD.innerHTML = "<div class='small'>–°–µ–≥–æ–¥–Ω—è –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>"; return; }
  if(todaysEvents.length>0){
    const h = document.createElement("div"); h.innerHTML = "<strong>–°–æ–±—ã—Ç–∏—è:</strong>"; elD.appendChild(h);
    todaysEvents.forEach(e=> elD.appendChild(Object.assign(document.createElement("div"),{innerText:`${e.time||''} ${e.title}`})));
  }
  if(todaysTasks.length>0){
    const h = document.createElement("div"); h.innerHTML = "<strong style='margin-top:8px'>–ó–∞–¥–∞—á–∏:</strong>"; elD.appendChild(h);
    todaysTasks.forEach(t=> elD.appendChild(Object.assign(document.createElement("div"),{innerText:`${t.time||''} ${t.title}`})));
  }
}

/* ====== cowboy animation control ====== */
function triggerCowboyRun(mode="run"){
  const cow = cowboyEl;
  if(!cow) return;
  if(mode==="run"){
    cow.classList.add("run");
    setTimeout(()=> cow.classList.remove("run"), 1400);
  } else if(mode==="celebrate"){
    // bigger hop
    cow.style.transform = "translateY(-8px) scale(1.05)";
    setTimeout(()=> cow.style.transform = "", 900);
  }
}

/* load cowboy image and fallback to svg if not found */
function ensureCowboyImage(){
  const img = el("#cowboyImg");
  img.addEventListener("error", ()=>{
    // fallback: simple SVG inline
    img.style.display = "none";
    const svgWrap = document.createElement("div");
    svgWrap.style.width = "86px"; svgWrap.style.height="86px";
    svgWrap.innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(10,5)">
        <rect width="80" height="50" rx="10" fill="#ffb86b"></rect>
        <circle cx="18" cy="20" r="8" fill="#7c5cff"></circle>
        <rect x="8" y="40" width="64" height="18" rx="6" fill="#7c5cff"></rect>
      </g>
    </svg>`;
    cowboyEl.appendChild(svgWrap);
  });
}
ensureCowboyImage();

/* ====== storage actions (import/export/clear) ====== */
el("#btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "starflow-export.json"; a.click();
});
el("#btnImport").addEventListener("click", ()=>{
  const input = document.createElement("input"); input.type="file"; input.accept=".json";
  input.onchange = e=> {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try { state = JSON.parse(r.result); saveState(); renderAll(); alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω"); } catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); }
    }; r.readAsText(f);
  }; input.click();
});
el("#btnClearAll").addEventListener("click", ()=>{
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?")){ state = {tasks:[],events:[],settings:{notifications:false,sound:true}}; saveState(); renderAll(); }
});

/* notifications & scheduler */
el("#notifToggle").addEventListener("change",(e)=>{
  w = e.target.checked;
  if(w){
    Notification.requestPermission().then(p=>{
      if(p==="granted"){ state.settings.notifications=true; saveState(); alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã"); }
      else { e.target.checked=false; state.settings.notifications=false; saveState(); alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã"); }
    });
  } else {
    state.settings.notifications=false; saveState();
  }
});
el("#soundToggle").addEventListener("change",(e)=>{ state.settings.sound = e.target.checked; saveState(); });

function scheduleCheck(){
  // called on add; main interval will check every 30 sec
}

/* interval checker for due items */
setInterval(()=>{
  const now = new Date();
  state.tasks.forEach(t=>{
    if(t.done) return;
    if(!t.date || !t.time) return;
    if(t._notified) return;
    const dt = new Date(t.date + "T" + (t.time||"00:00"));
    if(Math.abs(dt - now) < 60*1000){
      // notify
      if(state.settings.notifications && Notification.permission === "granted"){
        new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: " + t.title);
      }
      if(state.settings.sound) audioDing.play();
      t._notified = true; saveState();
      addToast("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: " + t.title);
    }
  });
}, 30*1000);

/* simple toast */
function addToast(txt){
  const to = document.createElement("div"); to.innerText = txt; to.style.position="fixed"; to.style.right="16px"; to.style.bottom="24px"; to.style.padding="10px 12px"; to.style.background="linear-gradient(90deg,#7c5cff,#ff7ab6)"; to.style.borderRadius="10px"; to.style.boxShadow="0 8px 20px rgba(0,0,0,0.5);"; to.style.zIndex=99999;
  document.body.appendChild(to); setTimeout(()=> to.style.opacity=0,2800); setTimeout(()=> to.remove(),3500);
}

/* tabs */
els(".tab").forEach(t=>{
  t.addEventListener("click", ()=> {
    els(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    els(".tab-pane").forEach(p=> p.style.display = "none");
    el("#pane-"+tab).style.display = "";
  });
});

/* particles background */
function initParticles(){
  const wrap = el("#particles");
  // create random 10 particles
  for(let i=0;i<12;i++){
    const p = document.createElement("div"); p.className="particle";
    const size = Math.random()*40+20;
    p.style.width = size+"px"; p.style.height = size+"px";
    p.style.left = Math.random()*100+"%"; p.style.top = Math.random()*100+"%";
    p.style.opacity = 0.08 + Math.random()*0.25;
    p.style.transform = `translate(-50%,-50%)`;
    wrap.appendChild(p);
    // animate
    (function(animP, idx){
      setInterval(()=> {
        animP.style.left = Math.random()*100+"%";
        animP.style.top = Math.random()*100+"%";
        animP.style.opacity = 0.05 + Math.random()*0.35;
      }, 4000 + idx*300);
    })(p,i);
  }
}
initParticles();

/* ===== initial load ===== */
loadState(); seedData(); renderAll();

/* ensure cowboy reacts when page visible and tasks added */
document.addEventListener("visibilitychange", ()=> { if(!document.hidden) triggerCowboyRun("run"); });

/* small helper to escape HTML */
function escapeHtml(s){ if(!s) return ""; return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

/* keyboard shortcuts for mobile (swipe) - left as optional */
/* end script */
</script>
</body>
</html>
