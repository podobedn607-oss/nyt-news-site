# backend/server.py
import os
from typing import List
from fastapi import FastAPI, Query
from fastapi.middleware.cors import CORSMiddleware
import feedparser
import requests
from newspaper import Article
from bs4 import BeautifulSoup
from openai import OpenAI

# --- Настройки ---
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")  # обязательно установи
if not OPENAI_API_KEY:
    raise RuntimeError("Установи переменную окружения OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)

app = FastAPI(title="NYT + GPT backend")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # для продакшена ограничь на домен фронтенда
    allow_methods=["*"],
    allow_headers=["*"],
)

# RSS NYT
NYT_RSS = [
    "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/World.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/US.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/Business.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/Technology.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/Science.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/Health.xml",
    "https://rss.nytimes.com/services/xml/rss/nyt/Arts.xml"
]

# Функция извлечения текста через requests + bs4
def extract_text_by_requests(url: str) -> str:
    headers = {"User-Agent": "Mozilla/5.0"}
    r = requests.get(url, headers=headers, timeout=15)
    r.raise_for_status()
    soup = BeautifulSoup(r.text, "html.parser")
    article_tag = soup.find("article")
    paragraphs = article_tag.find_all("p") if article_tag else soup.find_all("p")
    text = "\n\n".join(p.get_text(strip=True) for p in paragraphs if p.get_text(strip=True))
    return text.strip()

# Функция перевода через OpenAI
def translate_text_with_openai(text: str) -> str:
    max_chunk = 7000
    parts = [text[i:i+max_chunk] for i in range(0, len(text), max_chunk)]
    translated_parts: List[str] = []
    for i, part in enumerate(parts):
        prompt = f"Переведи следующий текст на русский язык, сохрани формат:\n\nЧасть {i+1}:\n{part}"
        resp = client.responses.create(model="gpt-4o-mini", input=prompt, text_format="text")
        translated = getattr(resp, "output_text", "[Ошибка перевода]")
        translated_parts.append(translated.strip())
    return "\n\n----\n\n".join(translated_parts)

# Endpoint: последние статьи
@app.get("/latest")
def latest(count: int = Query(20, description="макс. количество статей")):
    items = []
    seen = set()
    for feed_url in NYT_RSS:
        try:
            feed = feedparser.parse(feed_url)
        except:
            continue
        for entry in feed.entries:
            link = entry.get("link")
            if not link or link in seen:
                continue
            seen.add(link)
            title = entry.get("title", "")
            summary = entry.get("summary") or entry.get("description") or ""
            published = entry.get("published", "")
            image = None
            media = entry.get("media_content") or entry.get("media_thumbnail")
            if media:
                try:
                    if isinstance(media, list):
                        image = media[0].get("url")
                    else:
                        image = media.get("url")
                except:
                    image = None
            items.append({
                "title": title,
                "link": link,
                "summary": summary,
                "published": published,
                "image": image
            })
            if len(items) >= count:
                break
        if len(items) >= count:
            break
    return {"items": items}

# Endpoint: полный текст статьи и перевод
@app.get("/get_article")
def get_article(url: str = Query(..., description="URL статьи")):
    try:
        article = Article(url, language="en")
        article.download()
        article.parse()
        text = article.text or ""
    except:
        text = ""
    if not text:
        try:
            text = extract_text_by_requests(url)
        except Exception as e:
            return {"error": f"Не удалось получить текст статьи: {e}"}
    if not text.strip():
        return {"error": "Не удалось извлечь текст статьи (возможно paywall)."}
    try:
        translation = translate_text_with_openai(text)
    except Exception as e:
        translation = f"[Ошибка перевода: {e}]"
    return {"link": url, "text": text, "translation": translation}
